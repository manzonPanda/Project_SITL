// @version=5 
//indicator("PROJECT SITL [JAKE]", max_lines_count=500, max_boxes_count=500, max_labels_count=500, overlay=true)
strategy(title="PROJECT SITL [JAKE]", overlay=true,initial_capital=10000 ,currency = currency.USD, default_qty_type=strategy.cash,max_boxes_count=500)
import protradingart/pta_plot/11 as pp
i_pctStop = input(0.5, "% of Risk to Starting Equity Use to Size Positions") / 100
i_tpFactor = input(2, "Factor of stop determining target profit")
// Save the strat's equity on the first bar, which is equal to initial capital.
var initialCapital = strategy.equity

method timeSess(string timezone, string session) => time(timeframe.period, session, timezone) 
var tab  = table.new(position = position.top_right, columns = 1, rows = 1, bgcolor = color(color.rgb(2, 55, 124)), border_width = 1)

//Silver Bullet Periods
SB_AM_per = "America/New_York".timeSess("1000-1100") //period/session~The AM  Session Silver Bullet (10AMâ€”11AM New York local time)10:00 - 11:00
SB_LN_per = "America/New_York".timeSess("0300-0400")//period/session~The London Open Silver Bullet (3AMâ€”4AM New York local time)03:00 - 04:00
SB_PM_per = "America/New_York".timeSess("1400-1500") // period/session ~ The PM  Session Silver Bullet ( 2 PM â€”  3 PM New York local time)  14:00 - 15:00
//1hr before Silver Bullet Periods
HR_BEFORE_SB_AM_per = "America/New_York".timeSess("0900-1000")
HR_BEFORE_SB_LN_per = "America/New_York".timeSess("0200-0300")
HR_BEFORE_SB_PM_per = "America/New_York".timeSess("1300-1400") 
//2hrs after SB periods, close all pending order
post_SB_AM_per = "America/New_York".timeSess("1215-1300")
post_SB_LN_per = "America/New_York".timeSess("0500-0600")
post_SB_PM_per = "America/New_York".timeSess("1600-1800") 


col_SB      = input.color (#6c00d1f5,                '    '               , inline='SB' , group='Show'                        )  
minT        = syminfo.mintick

//-----------------------------------------------------------------------------}
//Variables
//-----------------------------------------------------------------------------{
tfs = (60 / (timeframe.in_seconds(timeframe.period) / 60)) / 2
is_in_SB  = SB_LN_per or SB_AM_per or SB_PM_per
is_in_hr_before_SB  = HR_BEFORE_SB_AM_per or HR_BEFORE_SB_LN_per or HR_BEFORE_SB_PM_per
strSB = is_in_SB  and not is_in_SB [1]
endSB  = not is_in_SB and is_in_SB [1]
startHrBeforeSB = is_in_hr_before_SB  and not is_in_hr_before_SB [1]
bull_fvg = low > high[2] and close[1] > high[2] and (low-high[2] >= 3*syminfo.mintick) 
bear_fvg = high < low[2] and close[1] < low[2] and (low[2]-high >= 3*syminfo.mintick)
bullAreaCss      = input.color(color.new(color.teal, 50), 'Area'     , inline = 'bull')
bullCss          = input.color(color.rgb(174,196,255), 'FVG Level'   , inline = 'bull')
bearCss          = input.color(color.red, 'FVG Level'                , inline = 'bear')
tpCss  = input.color(color.new(color.teal, 50), 'TP'  , inline = 'TP and SL')
slCss  = input.color(color.new(color.red, 50), 'SL' , inline = 'TP and SL')
n = bar_index
var line highLiquidityLine = na
var line lowLiquidityLine = na 
lGcss   = input(color.rgb(255, 0, 0), '')
var float max = na
var float min = na
float barHigh = na
float barLow = na
var string pattern = na
var string patternInfo = na
var bool patternFound = na
var bool continuationPatternFound = na
var int reversalFirstBearFVG = 1
var int reversalFirstBullFVG = 1
var int continuationFirstBearFVG = 1
var int continuationFirstBullFVG = 1
var float avg = na
var bool drawDownArrow = false
var bool drawUpArrow = false
var bool isReversalFailed = false
var array<box> bxUpArr = array.new<box>(0), var array<bool> bxUpArrBool = array.new<bool>(0)
var array<box> bxDnArr = array.new<box>(0), var array<bool> bxDnArrBool = array.new<bool>(0)
colDn = input.color(color.new(color.red, 86), "", inline ='2')
colUp = input.color(color.new(color.blue, 86), "", inline ='1')
colorNone = color.new(color.white, 100)
colorGray = color.new(color.gray, 50)

// Update times with UTC Offset - use in labels
utc_offset = input.int(-5, title="UTC Offset", minval=-12, maxval=12, tooltip="Select UTC offset for New York local time. In summer it is -4, in winter -5")
LDOAMCss  = input.color(color.new(#00bcd4, 90), '', inline = 'LDOAM', group = 'time zone')
NYLAMCss  = input.color(color.new(#00bcd4, 90), '', inline = 'NYLAM', group = 'time zone')
NYEPMCss  = input.color(color.new(#00bcd4, 90), '', inline = 'NYEPM', group = 'time zone')

LDOAM  = time(timeframe.period, "0300-0400", "UTC" + (utc_offset >= 0 ? "+" : "") + str.tostring(utc_offset)) 
NYLAM  = time(timeframe.period, "1000-1100", "UTC" + (utc_offset >= 0 ? "+" : "") + str.tostring(utc_offset)) 
NYEPM  = time(timeframe.period, "1400-1500", "UTC" + (utc_offset >= 0 ? "+" : "") + str.tostring(utc_offset)) 

//-----------------------------------------------------------------------------
//Functions
//-----------------------------------------------------------------------------
labels(session, css, txt,patternInfo)=>
    var label lbl = na
    var float max = na 
    var int anchor = na
    var get_css = color.rgb(color.r(css), color.g(css), color.b(css))

    if session and not session[1]
        max := high
        anchor := time
        
        lbl := label.new(anchor, max
          , txt
          , xloc.bar_time
          , color = #ffffff00
          , style = label.style_label_down
          , textcolor = get_css
          , size = size.large)
    
    if session
        max := math.max(high, max)
        if drawDownArrow or drawUpArrow or patternFound //update also the label text if FVG found or patternFound
            label.set_text(lbl, txt+'\n  FVG foundðŸ•˜: '+ str.format_time(time, "HH:mm z", "America/New_York")) 
        label.set_x(lbl, int(math.avg(time, anchor)))
        label.set_y(lbl, (syminfo.type=="index") ?  max+5:max+0.00005 )

addToSL()=>
    if syminfo.type=="index"
        var float price = 1.3
    else if syminfo.type=="forex"
        var float price = 0.00010

addSpreads()=>
    if syminfo.type=="index"
        var float price = 1
    else if syminfo.type=="forex"
        var float price = 0.00005

//This stops boxes painting when price passes to or through them
extendAndRemoveBx(array<box> boxArray, array<bool> boxArrayBool, simple bool isBull) =>  
    if boxArray.size() > 0
        for i = boxArray.size() -1 to 0
            box bx = boxArray.get(i)
            //bx.set_right(bar_index)
            //float price = isBull ? bx.get_top() : bx.get_bottom()      
            float price = isBull ? bx.get_bottom() : bx.get_top()      
            int m = isBull ? 1 : -1
            float hiLo = isBull ? high : low  
            if hiLo * m > price * m //high*1 > top*1 - check if price just hit FVG, not passes through
                //array.remove(boxArray,i) //remove element in array 
                //box.delete(bx) //remove box in chart
                if (pattern=='Reversal-below'and isBull) or (pattern=='Reversal-top'and not isBull) //only show FVGs that is in Continuation trend
                    //bx.set_bgcolor(colorGray)
                    boxArrayBool.set(i,true) //make the FVG to true


if startHrBeforeSB //find max and min 1hr before SB
    max := high //for getting the highest price 1hr before session
    min := low //for getting the lowest price 1hr before session
    //initiate liquidity lines with na first
    highLiquidityLine:= line.new(n,na,na,na, color = lGcss, style = line.style_dotted, width = 3)
    lowLiquidityLine:= line.new(n,na,na,na, color = lGcss, style = line.style_dotted, width = 3)
    patternFound:= false
    continuationPatternFound:= false
    pattern:="na"
    patternInfo:=""
    isReversalFailed:=false
    array.clear(id = bxUpArr) //clear array of bull FVGs
    array.clear(id = bxDnArr) //clear array of bear FVGs
    array.clear(id = bxUpArrBool) //clear array of bull FVGs bool
    array.clear(id = bxDnArrBool) //clear array of bear FVGs bool

if strSB
    line.new(bar_index, close, bar_index, close + 10, color= col_SB, extend=extend.both,width = 3)
    //extend lines of liquidity grabs to SB session
    line.set_y1(highLiquidityLine, max) 
    line.set_xy2(highLiquidityLine, n+59, max)
    line.set_y1(lowLiquidityLine, min) 
    line.set_xy2(lowLiquidityLine, n+59, min)
if endSB
    line.new(bar_index, close, bar_index, close + 10, color= col_SB, extend=extend.both,width = 3)
    //patternFound:= false
    isReversalFailed:=false

if is_in_hr_before_SB
    tempMax = math.max(high, max) //check if there is a new high
    tempMin = math.min(low, min) //check if there is a new low
    max:=tempMax
    min:=tempMin
    line.set_y1(highLiquidityLine, max) 
    line.set_xy2(highLiquidityLine, n, max)
    line.set_y1(lowLiquidityLine, min) 
    line.set_xy2(lowLiquidityLine, n, min)
    reversalFirstBearFVG:=1
    reversalFirstBullFVG:=1
    continuationFirstBearFVG:=1
    continuationFirstBullFVG:=1

//draw FVGs only in the inside of SB timezone
if is_in_SB
    if low<min and not patternFound
        pattern:="Reversal-below"
        patternInfo:= ' ('+str.tostring(low) +'<' + str.tostring(min) +')'
        patternFound:=true
    if high>max and not patternFound
        pattern:="Reversal-top"
        patternInfo:= ' ('+ str.tostring(high) +'>' + str.tostring(max) +')'
        patternFound:=true

    if bear_fvg //put all bear FVG found in array(bxDnArr)
        bxDnArr.push(box.new(bar_index-2, low[2], bar_index, high, bgcolor = colorNone , border_color = colorNone,text_valign=text.align_bottom,text_halign = text.align_right,text_size = size.small)) //left,top,right,bottom,bgcolor..
        bxDnArrBool.push(false) //for tracking purposes if FVG hit
    if bull_fvg //put all bull FVG found in array(bxUpArr)
        bxUpArr.push(box.new(bar_index-2, low, bar_index, high[2], bgcolor = colorNone, border_color = colorNone,text_valign=text.align_bottom,text_halign = text.align_right,text_size = size.small))
        bxUpArrBool.push(false) //for tracking purposes if FVG hit

    // *** Risk management sample*** //
    //entry_price = close 
    //percent_diff = 5
    //rrr = 2
    //stop_loss_price = (1 percent_diff / 100.) entry_price
    //take_profit_price = (1 + rrr * percent_diff / 100.) * entry_price
    //SL in ticks = (entry_price - stop_loss_price)/syminfo.mintick
    //TP in ticks =(take_profit_price - entry_price)/syminfo.mintick
    //***************************//

    //or (isReversalFailed and pattern !="Reversal-below")
    if (patternFound and pattern=="Reversal-below") or isReversalFailed
        if (bull_fvg and reversalFirstBullFVG !=0 )
         or (bull_fvg and continuationFirstBullFVG !=0 and isReversalFailed and pattern !="Reversal-below") //this is for entering ContinuationEntry if no FVG found yet
            drawUpArrow:= true
            entry_price = low //use this if you want your entry ABOVE the upper base of FVG (for spreads)
            //entry_price = low //use this if you want your entry in the upper base of FVG
            //entry_price = math.avg(low,high[2]) //use this if you want your entry in the middle of FVG
            stopLoss=low[2]
            addedSL= addToSL()
            finalSL=stopLoss-addedSL 
            takeProfit=(entry_price-finalSL)*2+entry_price //TP (RRR=1.5)
            box.new(n +3, low, n-2, high[2], na, bgcolor = bullCss) //FVG
            box.new(n +3, takeProfit, n+1, entry_price, na, bgcolor = tpCss) //TP (RRR=3)
            box.new(n +3, finalSL, n+1, entry_price, na, bgcolor = slCss) //SL
            sl_in_ticks=(finalSL - entry_price)/syminfo.mintick
            tp_in_ticks=(takeProfit-entry_price)/syminfo.mintick
            longDiffSL= math.abs(entry_price-finalSL)
            positionValue = initialCapital * i_pctStop / (longDiffSL / entry_price)
            positionSize = positionValue / entry_price
            strategy.entry(id = str.tostring(n), qty=positionSize, direction = strategy.long , limit = entry_price)
            strategy.exit(id = "Exit" , from_entry = str.tostring(n), stop = finalSL, profit = tp_in_ticks, 
             comment_profit="TP hit",comment_loss="SL hit" )
            reversalFirstBullFVG:= reversalFirstBullFVG-1
            continuationFirstBullFVG:= continuationFirstBullFVG-1
    //or (isReversalFailed and pattern !="Reversal-top")
    if patternFound and pattern=="Reversal-top" 
        if (bear_fvg and reversalFirstBearFVG !=0 )
         //or (bear_fvg and continuationFirstBearFVG !=0 and isReversalFailed)
            drawDownArrow := true
            entry_price = high //use this if you want your entry ABOVE the upper base of FVG (for spreads)
            //entry_price = high //use this if you want your entry in the lower base of FVG
            //entry_price = math.avg(high,low[2]) //use this if you want your entry in the middle of FVG
            stopLoss=high[2] //tick of the first bar 
            addedSL= addToSL()
            finalSL=stopLoss+addedSL 
            takeProfit=(entry_price-finalSL)*2+entry_price //TP (RRR=1.5)
            box.new(n +3, high, n-2, low[2], na, bgcolor = bearCss) //FVG
            box.new(n +3, takeProfit, n+1, entry_price, na, bgcolor = tpCss) //TP (RRR=3)
            box.new(n +3, finalSL, n+1, entry_price, na, bgcolor = slCss) //SL
            sl_in_ticks=(finalSL - entry_price)/syminfo.mintick
            tp_in_ticks=(entry_price-takeProfit)/syminfo.mintick
            longDiffSL= math.abs(entry_price-finalSL)
            positionValue = initialCapital * i_pctStop / (longDiffSL / entry_price)
            positionSize = positionValue / entry_price
            strategy.entry(id = str.tostring(n), qty=positionSize, direction = strategy.short , limit = entry_price)
            strategy.exit(id = "Exit" , from_entry = str.tostring(n), stop = finalSL, profit = tp_in_ticks, 
             comment_profit="TP hit",comment_loss="SL hit")
            reversalFirstBearFVG:=  reversalFirstBearFVG-1
            continuationFirstBearFVG:= continuationFirstBearFVG-1



//if the closed trade is within an hour AND profit is loss AND inside SB, look for continuation
if (not isReversalFailed and bar_index - strategy.closedtrades.entry_bar_index(strategy.closedtrades-1) < 60 
 and strategy.closedtrades.profit(strategy.closedtrades-1) < 0) and (LDOAM or NYLAM or NYEPM)    //if entry is loss and inside SB
    isReversalFailed:= true
    labels(LDOAM, LDOAMCss, '\n Reversal failed',patternInfo)
    labels(NYLAM, NYLAMCss, '\n Reversal failed' + '\n Min: '+str.tostring(min),patternInfo)
    labels(NYEPM, NYEPMCss, '\n Reversal failed'+ '\n Min: '+str.tostring(min),patternInfo)

    //look for continuation - show all hidden FVGs
    if pattern=='Reversal-top' //show all bull FVGs
        for i = 0 to bxUpArr.size()-1
            box bx = bxUpArr.get(i)
            if bxUpArrBool.get(i) == false //if FVG does not hit yet
                bx.set_bgcolor(color.green)
            else                            //if FVG hit
                bx.set_bgcolor(colorGray)
         
        ////To be continue
        ////box.new(bar_index-2, low[2], bar_index, high...
        //firstIndexFoundFalse = array.indexof(bxUpArrBool, false)
        //box bx = bxUpArr.get(firstIndexFoundFalse) //left,top,right,bottom,bgcolor..
       // drawUpArrow:= true
        //entry_price = low //use this if you want your entry ABOVE the upper base of FVG (for spreads)
        ////entry_price = low //use this if you want your entry in the upper base of FVG
        ////entry_price = math.avg(low,high[2]) //use this if you want your entry in the middle of FVG
        //stopLoss=low[2] 
        //stopLoss2=low[box.get_left(bx)  ]
        //addedSL= addToSL()
        //finalSL=stopLoss-addedSL 
        //takeProfit=(entry_price-finalSL)*2+entry_price //TP (RRR=1.5)
        //box.new(n +3, low, n-2, high[2], na, bgcolor = bullCss) //FVG
        //box.new(n +3, takeProfit, n+1, entry_price, na, bgcolor = tpCss) //TP (RRR=3)
        //box.new(n +3, finalSL, n+1, entry_price, na, bgcolor = slCss) //SL
        //sl_in_ticks=(finalSL - entry_price)/syminfo.mintick
        //tp_in_ticks=(takeProfit-entry_price)/syminfo.mintick
        //longDiffSL= math.abs(entry_price-finalSL)
        //positionValue = initialCapital * i_pctStop / (longDiffSL / entry_price)
        //positionSize = positionValue / entry_price
        //strategy.entry(id = str.tostring(n), qty=positionSize, direction = strategy.long , limit = entry_price)
        //strategy.exit(id = "Exit" , from_entry = str.tostring(n), stop = finalSL, profit = tp_in_ticks, 
        //    comment_profit="TP hit",comment_loss="SL hit" )
        //reversalFirstBullFVG:= reversalFirstBullFVG-1
        //continuationFirstBullFVG:= continuationFirstBullFVG-1


    if pattern=='Reversal-below' //show all bear FVGs
        for i = 0 to bxDnArr.size()-1
            box bx = bxDnArr.get(i)
            if bxDnArrBool.get(i) == false  //if FVG does not hit yet
                bx.set_bgcolor(color.red)
            else                            //if FVG hit
                bx.set_bgcolor(colorGray)

    //continuation entry..Get the index of the last occurrence of TRUE in an array and set all preceding values to TRUE..
    //false - FVG not yet hit
    //true  - FVG got hit
    //purple is the first TRUE (FVG hit) before SL
    //yellow are disabled FVGs
    //gray are already hit
    if pattern=='Reversal-top'
        bool isFound = false
        for i = bxUpArrBool.size()-1 to 0
            if bxUpArrBool.get(i) == true and not isFound
                isFound:=true
                box.set_bgcolor(id = bxUpArr.get(i), color = color.purple) 
            if bxUpArrBool.get(i) == false and isFound
                //bxUpArrBool.set(i,true)   
                box.set_bgcolor(id = bxUpArr.get(i), color = color.yellow) 
           // if bxUpArrBool.get(i) == false and 
        //continuationEntry(bxDnArrBool)

    if pattern=='Reversal-below'
        bool isFound = false
        for i = bxDnArrBool.size()-1 to 0
            if bxDnArrBool.get(i) == false and isFound 
                box.set_bgcolor(id = bxDnArr.get(i), color = color.yellow) 
            if bxDnArrBool.get(i) == true and not isFound
                isFound:=true
                box.set_bgcolor(id = bxDnArr.get(i), color = color.purple) 

//continuationEntry(array<bool> boxArrayBool)=>
    //for i = bxUpArrBool.size()-1 to 0


if post_SB_AM_per or  post_SB_LN_per or post_SB_PM_per //cancel pending orders after 1hr
    strategy.cancel_all() 
    strategy.close_all(comment='closed trade')

plotchar(
 series     = not na(SB_LN_per) and na(SB_LN_per[1]),
 title      = "3-4 AM ",
 //char       = " ",
 location   =  location.top,
 color      = color.new(color = color.red , transp = 30),
 offset     = +tfs,
 text       = "3-4 AM\nNY\nBy Jake",
 textcolor  = color.new(color = color.purple , transp = 30)
 //editable   =  ,
 //size       =  ,
 //show_last  = ,
 //display    =  
 )
    
//-----------------------------------------------------------------------------
//Labels
//-----------------------------------------------------------------------------
labels(LDOAM, LDOAMCss, '3:00-4:00 AM \n Pattern found: '+pattern + patternInfo + '\n Max: '+str.tostring(max)+ '\n Min: '+str.tostring(min),patternInfo)
labels(NYLAM, NYLAMCss, '10:00-11:00 AM \n Pattern found: '+pattern + patternInfo + '\n Max: '+str.tostring(max)+ '\n Min: '+str.tostring(min),patternInfo)
labels(NYEPM, NYEPMCss, '2:00-3:00 PM \n Pattern found: '+pattern + patternInfo  + '\n Max: '+str.tostring(max)+ '\n Min: '+str.tostring(min),patternInfo)
extendAndRemoveBx(bxDnArr,bxDnArrBool, true) //for bull FVGs
extendAndRemoveBx(bxUpArr,bxUpArrBool, false) //for bear FVGs

//plotchar(drawDownArrow, offset=-1, title="drawDownArrow", color=color.red, char='â¬‡', size=size.normal,location=location.abovebar)
//plotchar(drawUpArrow, offset=-1, title="drawUpArrow", color=color.green, char='â¬†', size=size.normal, location=location.belowbar)    
plotshape(drawDownArrow and not isReversalFailed, title="Oversold", offset=-1,location=location.abovebar, color=color.red, style=shape.labeldown, size=size.normal, text="Reversal", textcolor=color.white)
plotshape(drawUpArrow and not isReversalFailed, title="Overbought", offset=-1,location=location.belowbar, color=color.green, style=shape.labelup, size=size.normal, text="Reversal", textcolor=color.white)
plotshape(drawDownArrow and isReversalFailed, title="Oversold", offset=-1,location=location.abovebar, color=color.red, style=shape.labeldown, size=size.normal, text="Continuation", textcolor=color.white)
plotshape(drawUpArrow and isReversalFailed, title="Overbought", offset=-1,location=location.belowbar, color=color.green, style=shape.labelup, size=size.normal, text="Continuation", textcolor=color.white)

drawDownArrow := false
drawUpArrow := false
//display info on the upper right corner
if barstate.islast
    if timeframe.in_seconds(timeframe.period) > 15 * 60
        true

//table.cell(tab, 0, 0, text = 'Max: '+max , text_color=#fcfcfc)
table.cell(tab, 0, 0, text = 'Project SITL [Jake]' + '\n Date: Nov. 8, 2023'+ '\nType: ' + str.tostring(syminfo.type) + 
 '\n mintick: '+str.tostring(syminfo.mintick)+ '\n'+str.tostring(strategy.closedtrades.profit(strategy.closedtrades-1)), text_color=#fcfcfc)

